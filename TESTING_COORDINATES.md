# Тестирование изменения координат в 2ГИС интеграции

## Что было исправлено

### Проблема
При изменении координат (`latitude` и `longitude`) карта и инфраструктура не обновлялись.

### Решение
1. **Map2GIS компонент:**
   - Карта теперь инициализируется только один раз
   - При изменении координат карта обновляет центр (`setView`) вместо пересоздания
   - Маркер ЖК удаляется и создается заново при изменении координат
   - Маркеры инфраструктуры корректно обновляются

2. **ComplexInfrastructure компонент:**
   - Добавлены логи для отладки
   - `useEffect` правильно реагирует на изменение `latitude` и `longitude`
   - При изменении координат автоматически перезагружаются данные с 2ГИС API

## Как протестировать

### Вариант 1: Использование тестового компонента

Я создал специальный компонент для тестирования - `InfrastructureTester.jsx`

1. **Откройте файл страницы для тестирования** (например, создайте новый роут или используйте существующую страницу):

```javascript
// В любом файле страницы, например src/pages/TestPage.jsx
import React from 'react';
import InfrastructureTester from '../components/Complex/InfrastructureTester';

const TestPage = () => {
    return (
        <div style={{ padding: '20px' }}>
            <h1>Тестирование 2ГИС интеграции</h1>
            <InfrastructureTester />
        </div>
    );
};

export default TestPage;
```

2. **Добавьте роут** (если нужно) в `App.js`:

```javascript
import TestPage from './pages/TestPage';

// В роутах
<Route path="/test-2gis" element={<TestPage />} />
```

3. **Откройте страницу в браузере:**
   - Перейдите на `/test-2gis`
   - В правом верхнем углу появится панель с кнопками тестовых локаций

4. **Тестируйте изменение координат:**
   - Нажимайте на кнопки с разными локациями
   - Карта и список инфраструктуры должны обновляться
   - Попробуйте ввести свои координаты в поля ввода

### Вариант 2: Тестирование на реальной странице ЖК

1. **Убедитесь, что у ЖК в БД есть координаты:**

```sql
-- Проверьте координаты
SELECT id, name, latitude, longitude FROM residential_complex;

-- Если координат нет, обновите:
UPDATE residential_complex
SET latitude = 43.238949, longitude = 76.889709
WHERE id = 1;
```

2. **Откройте страницу ЖК:**
   - Перейдите на `/complex/1` (или другой id)
   - Прокрутите до секции "Инфраструктура"
   - Должна отобразиться карта с маркерами

3. **Измените координаты в БД:**
   ```sql
   -- Измените на другую локацию
   UPDATE residential_complex
   SET latitude = 51.132588, longitude = 71.403840
   WHERE id = 1;
   ```

4. **Обновите страницу:**
   - Карта должна показать новое место
   - Инфраструктура должна быть другая

### Вариант 3: Проверка через консоль браузера

1. Откройте DevTools (F12) -> Console
2. Откройте страницу ЖК
3. В консоли должны появиться логи:
   ```
   Загрузка инфраструктуры для координат: 43.238949 76.889709
   Парсированные координаты: 43.238949 76.889709
   Загружено категорий инфраструктуры: 4
   Загружено маркеров: 15
   ```

4. Если вы измените координаты (через тестер или в БД и обновите страницу), логи должны обновиться

## Тестовые координаты

### Алматы
- **ЖК Нурсая**: lat: `43.238949`, lon: `76.889709`
- **Мегацентр**: lat: `43.225969`, lon: `76.851522`
- **Достык Плаза**: lat: `43.236715`, lon: `76.945798`

### Астана
- **Khan Shatyr**: lat: `51.132588`, lon: `71.403840`
- **Байтерек**: lat: `51.128422`, lon: `71.430564`
- **Mega Silk Way**: lat: `51.090697`, lon: `71.415326`

### Шымкент
- **Центр**: lat: `42.340889`, lon: `69.596778`

## Что проверять

1. **Карта обновляется:**
   - При изменении координат центр карты смещается
   - Маркер ЖК перемещается на новое место

2. **Инфраструктура обновляется:**
   - Список объектов меняется в зависимости от локации
   - Маркеры на карте соответствуют списку

3. **Расстояния корректны:**
   - Расстояния до объектов пересчитываются
   - Ближайшие объекты показываются первыми

4. **Нет ошибок:**
   - В консоли нет ошибок
   - Карта загружается без проблем
   - API 2ГИС отвечает

## Возможные проблемы

### Карта не обновляется
- **Проверьте консоль:** Есть ли ошибки?
- **Проверьте логи:** Видны ли логи загрузки инфраструктуры?
- **Очистите кэш:** Ctrl+Shift+R (или Cmd+Shift+R на Mac)

### Координаты не меняются
- **Проверьте, что координаты действительно изменились в БД**
- **Обновите страницу после изменения в БД**
- **Проверьте, что `latitude` и `longitude` передаются в компонент**

### Нет данных инфраструктуры
- **Проверьте координаты:** Они должны быть корректными
- **Проверьте радиус:** По умолчанию 1000м, возможно нужно увеличить
- **Проверьте API 2ГИС:** Работает ли API?

## Отладка

### Добавьте временные логи в компонент:

```javascript
// В ComplexDetailPage.jsx
console.log('Complex data:', complex);
console.log('Latitude:', complex.latitude);
console.log('Longitude:', complex.longitude);
```

### Проверьте Network запросы:

1. Откройте DevTools -> Network
2. Отфильтруйте по `catalog.api.2gis.com`
3. Должны быть запросы к 2ГИС API
4. Проверьте ответы API

## После тестирования

Когда убедитесь, что все работает:

1. **Удалите тестовый компонент** (если не нужен):
   - Удалите `InfrastructureTester.jsx`
   - Удалите тестовый роут из `App.js`

2. **Удалите логи** из `ComplexInfrastructure.jsx`:
   - Уберите `console.log` из продакшн версии
   - Или замените на условные логи (только в dev режиме)

3. **Обновите документацию** `2GIS_INTEGRATION.md` если нужно

## Пример использования в продакшене

```javascript
// ComplexDetailPage.jsx
<div id="infrastructure">
    <ComplexInfrastructure
        latitude={complex.latitude}
        longitude={complex.longitude}
        complexName={complex.name}
    />
</div>
```

При изменении `complex.latitude` или `complex.longitude` компонент автоматически:
1. Перезагрузит данные с 2ГИС API
2. Обновит карту
3. Обновит маркеры
4. Обновит список инфраструктуры

## Дополнительные улучшения (опционально)

Если хотите добавить больше контроля:

```javascript
// Добавить кнопку "Обновить инфраструктуру"
const handleRefresh = () => {
    // Принудительно перезагрузить данные
    setInfrastructure([]);
    setMarkers([]);
    loadInfrastructure();
};
```

Или добавить debounce для частых изменений:

```javascript
import { useDebounce } from 'use-debounce';

const [debouncedLat] = useDebounce(latitude, 500);
const [debouncedLon] = useDebounce(longitude, 500);

useEffect(() => {
    loadInfrastructure();
}, [debouncedLat, debouncedLon]);
```
